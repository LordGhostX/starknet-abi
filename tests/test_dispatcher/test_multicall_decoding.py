from starknet_abi.dispatch import _parse_tx_calldata


def test_v0_multicall_parsing():
    calldata = [
        2,
        2087021424722619777119509474943472645767659996348769578120564519014510906823,
        949021990203918389843157787496164629863144228991510976554585288817234167820,
        0,
        3,
        467359278613506166151492726487752216059557962335532790304583050955123345960,
        602962535134499854912799851629033993488593928113527484350375636311213640489,
        3,
        6,
        9,
        467359278613506166151492726487752216059557962335532790304583050955123345960,
        30000000000000000,
        0,
        1,
        2087021424722619777119509474943472645767659996348769578120564519014510906823,
        30000000000000000,
        0,
        38403080,
        0,
        14,
    ]

    parsed_calls = _parse_tx_calldata(calldata, 0)

    assert len(parsed_calls) == 2

    assert parsed_calls[0][0] == bytes.fromhex(
        "049d36570d4e46f48e99674bd3fcc84644ddd6b96f7c741b1562b82f9e004dc7"
    )
    assert parsed_calls[0][1] == bytes.fromhex(
        "0219209e083275171774dab1df80982e9df2096516f06319c5c6d71ae0a8480c"
    )
    assert parsed_calls[0][2] == [
        467359278613506166151492726487752216059557962335532790304583050955123345960,
        30000000000000000,
        0,
    ]

    assert parsed_calls[1][0] == bytes.fromhex(
        "010884171baf1914edc28d7afb619b40a4051cfae78a094a55d230f19e944a28"
    )
    assert parsed_calls[1][1] == bytes.fromhex(
        "015543c3708653cda9d418b4ccd3be11368e40636c10c44b18cfe756b6d88b29"
    )
    assert len(parsed_calls[1][2]) == 6


def test_v1_multicall_parsing():
    calldata = [
        2,
        156118869544040767245479469729111978302124225586688183800009809053137844788,
        949021990203918389843157787496164629863144228991510976554585288817234167820,
        3,
        2149625499377050772775701191274921578103398273298955620360611655307104287237,
        26006095679012345679,
        0,
        2149625499377050772775701191274921578103398273298955620360611655307104287237,
        352040181584456735608515580760888541466059565068553383579463728554843487745,
        2,
        156118869544040767245479469729111978302124225586688183800009809053137844788,
        26006095679012345679,
    ]

    parsed_calls = _parse_tx_calldata(calldata, 1)

    assert len(parsed_calls) == 2

    assert parsed_calls[0][0] == bytes.fromhex(
        "00585c32b625999e6e5e78645ff8df7a9001cf5cf3eb6b80ccdd16cb64bd3a34"
    )
    assert parsed_calls[0][1] == bytes.fromhex(
        "0219209e083275171774dab1df80982e9df2096516f06319c5c6d71ae0a8480c"
    )
    assert parsed_calls[0][2] == [
        2149625499377050772775701191274921578103398273298955620360611655307104287237,
        26006095679012345679,
        0,
    ]

    assert parsed_calls[1][0] == bytes.fromhex(
        "04c0a5193d58f74fbace4b74dcf65481e734ed1714121bdc571da345540efa05"
    )
    assert parsed_calls[1][1] == bytes.fromhex(
        "00c73f681176fc7b3f9693986fd7b14581e8d540519e27400e88b8713932be01"
    )
    assert len(parsed_calls[1][2]) == 2
